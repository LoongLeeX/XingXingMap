# 🗺️ 2D 模式强制说明

## 📝 需求

在 2D 视图下，无论选择哪种地图类型（地图、卫星、混合、地形），都应该**始终保持 2D 俯视视角**，不允许倾斜或旋转。

---

## ✅ 已实现的功能

### 1. 地图类型选项
```typescript
// 四种地图类型，全部强制 2D 模式
MAP_TYPES = [
  { value: 'roadmap', label: '地图' },     // 普通地图
  { value: 'satellite', label: '卫星' },   // 卫星图
  { value: 'hybrid', label: '混合' },      // 卫星 + 标注
  { value: 'terrain', label: '地形' },     // 地形图
]
```

### 2. 强制 2D 配置

#### 初始化时强制 2D
```typescript
// useMapInstance.ts
const mapInstance = new google.maps.Map(container, {
  center: finalConfig.center,
  zoom: finalConfig.zoom,
  mapTypeId: finalConfig.mapType,
  // 强制 2D 配置
  tilt: 0,              // 禁用倾斜（0° = 俯视）
  heading: 0,           // 禁用旋转（0° = 正北）
  rotateControl: false, // 禁用旋转控件
});
```

#### 切换地图类型时强制 2D
```typescript
// Map2D.tsx
useEffect(() => {
  if (map && isReady) {
    map.setMapTypeId(mapType);
    // 每次切换都强制保持 2D
    map.setTilt(0);      // 重置倾斜角度
    map.setHeading(0);   // 重置旋转角度
  }
}, [map, isReady, mapType]);
```

---

## 🔧 实现细节

### 修改的文件

| 文件 | 修改内容 | 目的 |
|------|----------|------|
| `useMapInstance.ts` | 初始化时设置 `tilt: 0, heading: 0, rotateControl: false` | 创建地图时就强制 2D |
| `Map2D.tsx` | 切换类型时调用 `setTilt(0)` 和 `setHeading(0)` | 确保切换后仍保持 2D |
| `map.constants.ts` | 设置 `rotateControl: false` | 隐藏旋转控件 |

### 关键参数说明

#### `tilt`（倾斜角度）
- **范围**: 0° - 90°
- **0°**: 完全俯视（2D 模式）
- **45°**: 倾斜视角（3D 模式）
- **设置**: `tilt: 0` → 强制 2D

#### `heading`（旋转角度）
- **范围**: 0° - 360°
- **0°**: 正北方向
- **设置**: `heading: 0` → 统一朝向

#### `rotateControl`（旋转控件）
- **true**: 显示旋转/倾斜控件
- **false**: 隐藏控件（防止用户手动调整）

---

## 🎯 用户体验

### 在 2D 视图下

**✅ 可以做的：**
- 切换地图类型（地图/卫星/混合/地形）
- 缩放地图（放大/缩小）
- 平移地图
- 点击添加标记
- 搜索地址

**❌ 不能做的：**
- 倾斜地图（始终保持俯视）
- 旋转地图（始终正北朝上）
- 使用旋转控件（已隐藏）

### 在 3D 视图下

**✅ 可以做的：**
- 查看 3D 真实感建筑
- 倾斜和旋转视角
- 探索立体景观

---

## 🔍 对比：2D vs 3D

| 特性 | 2D 视图 | 3D 视图 |
|------|---------|---------|
| **倾斜** | ❌ 禁用（tilt: 0） | ✅ 启用 |
| **旋转** | ❌ 禁用（heading: 0） | ✅ 启用 |
| **地图类型** | ✅ 4种（地图/卫星/混合/地形） | ⚠️ 仅混合模式 |
| **标记显示** | ✅ 支持 | ❌ 暂不支持 |
| **旋转控件** | ❌ 隐藏 | ✅ 显示 |

---

## 🧪 测试验证

### 测试步骤

1. **打开应用**
   ```
   http://localhost:3000
   ```

2. **确认在 2D 视图**
   - 左上角应显示 "📱 2D 视图"

3. **测试地图类型切换**
   ```
   点击：地图 → 验证保持俯视
   点击：卫星 → 验证保持俯视
   点击：混合 → 验证保持俯视
   点击：地形 → 验证保持俯视
   ```

4. **尝试改变视角**
   - 右键拖拽 → 不应倾斜
   - 按住 Shift 拖拽 → 不应倾斜
   - Ctrl/Cmd + 拖拽 → 不应旋转

5. **验证控件**
   - 不应该看到旋转/倾斜控件（罗盘图标）
   - 只应该看到缩放控件（+/-）

### 预期结果

✅ **成功**：地图始终保持俯视，无法倾斜或旋转  
❌ **失败**：地图可以倾斜到 45° 或旋转

---

## 💡 技术原理

### Google Maps API 的视角控制

Google Maps 使用以下参数控制视角：

```typescript
// 2D 模式（俯视）
{
  tilt: 0,      // 0° = 完全俯视
  heading: 0,   // 0° = 正北朝上
  zoom: 12      // 缩放级别
}

// 3D 模式（倾斜）
{
  tilt: 45,     // 45° = 倾斜视角
  heading: 90,  // 90° = 东方朝上
  zoom: 18      // 通常更大的缩放
}
```

### 为什么需要两次设置？

1. **初始化时设置**（`useMapInstance.ts`）
   - 创建地图时就使用 2D 配置
   - 确保首次渲染就是 2D

2. **切换类型时设置**（`Map2D.tsx`）
   - 防止某些地图类型默认启用 3D
   - 确保每次切换都重置为 2D

---

## 🐛 可能的问题

### 问题 1：卫星图自动切换到 45°
**原因**：某些区域的卫星图默认启用 3D  
**解决**：在切换类型后强制 `setTilt(0)`

### 问题 2：用户手动旋转地图
**原因**：用户使用快捷键或手势  
**解决**：禁用 `rotateControl` 并监听变化

### 问题 3：分屏模式不一致
**原因**：分屏左右两侧配置不同  
**解决**：两侧都使用相同的 2D 配置

---

## 📊 实际效果

### 控制台日志

```
🗺️ [Map2D] 地图类型已切换: roadmap - 保持 2D 模式
🗺️ [Map2D] 地图类型已切换: satellite - 保持 2D 模式
🗺️ [Map2D] 地图类型已切换: hybrid - 保持 2D 模式
🗺️ [Map2D] 地图类型已切换: terrain - 保持 2D 模式
```

### UI 表现

```
┌─────────────────────────┐
│ 视图模式: 2D 视图        │
├─────────────────────────┤
│ 地图类型:               │
│ [地图] [卫星] [混合] [地形] │
└─────────────────────────┘
      ↓
   始终俯视 ✅
```

---

## ✨ 总结

**核心原则**：2D 视图 = 永远俯视（tilt: 0, heading: 0）

**实现方式**：
1. 初始化强制 2D ✅
2. 切换类型强制 2D ✅
3. 禁用旋转控件 ✅
4. 所有地图类型统一处理 ✅

**结果**：无论选择哪种地图类型，2D 视图都保持完全俯视！🎉

