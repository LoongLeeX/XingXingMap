<!DOCTYPE html>
<html>
  <head>
    <title>Test 3D Map with Markers</title>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map-container {
        width: 100%;
        height: 100%;
      }
      gmp-map-3d {
        width: 100%;
        height: 100%;
      }
      #info {
        position: absolute;
        top: 10px;
        left: 10px;
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        font-family: Arial, sans-serif;
        z-index: 1000;
      }
      #api-key-input-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }
      #api-key-form {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        max-width: 500px;
        width: 90%;
      }
      #api-key-form h2 {
        margin-top: 0;
        color: #333;
      }
      #api-key-form input {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
        box-sizing: border-box;
      }
      #api-key-form button {
        width: 100%;
        padding: 12px;
        background: #4285f4;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 10px;
      }
      #api-key-form button:hover {
        background: #357ae8;
      }
      #api-key-form .hint {
        font-size: 12px;
        color: #666;
        margin: 5px 0;
      }
      #api-key-form .clear-btn {
        background: #dc3545;
        margin-top: 5px;
      }
      #api-key-form .clear-btn:hover {
        background: #c82333;
      }
      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <!-- API Key è¾“å…¥ç•Œé¢ -->
    <div id="api-key-input-container" class="hidden">
      <div id="api-key-form">
        <h2>ğŸ—ºï¸ è¾“å…¥ Google Maps API Key</h2>
        <p class="hint">è¯·è¾“å…¥æ‚¨çš„ Google Maps API Key ä»¥åŠ è½½ 3D åœ°å›¾</p>
        <input 
          type="text" 
          id="api-key-input" 
          placeholder="AIzaSy..." 
          autocomplete="off"
        />
        <button onclick="saveApiKey()">ä¿å­˜å¹¶åŠ è½½åœ°å›¾</button>
        <button class="clear-btn" onclick="clearApiKey()">æ¸…é™¤ç¼“å­˜çš„ Key</button>
      </div>
    </div>
    
    <div id="info">
      <h3>3D åœ°å›¾ + æ ‡è®°æµ‹è¯•</h3>
      <p>ğŸ—ºï¸ æ—§é‡‘å±±é‡‘é—¨å¤§æ¡¥</p>
      <p>ğŸ“ å¤šä¸ª 3D æ ‡è®°</p>
    </div>
    <div id="map-container"></div>

    <script>
      const STORAGE_KEY = 'test_3d_map_key';
      
      // ä» localStorage è·å– API key
      function getApiKey() {
        return localStorage.getItem(STORAGE_KEY);
      }
      
      // ä¿å­˜ API key åˆ° localStorage
      function saveApiKeyToStorage(apiKey) {
        localStorage.setItem(STORAGE_KEY, apiKey);
      }
      
      // æ˜¾ç¤º API key è¾“å…¥ç•Œé¢
      function showApiKeyInput() {
        const container = document.getElementById('api-key-input-container');
        container.classList.remove('hidden');
        const input = document.getElementById('api-key-input');
        const existingKey = getApiKey();
        if (existingKey) {
          input.value = existingKey;
        }
        input.focus();
      }
      
      // éšè— API key è¾“å…¥ç•Œé¢
      function hideApiKeyInput() {
        document.getElementById('api-key-input-container').classList.add('hidden');
      }
      
      // ä¿å­˜ API key å¹¶åŠ è½½åœ°å›¾
      function saveApiKey() {
        const input = document.getElementById('api-key-input');
        const apiKey = input.value.trim();
        
        if (!apiKey) {
          alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ API Key');
          return;
        }
        
        saveApiKeyToStorage(apiKey);
        hideApiKeyInput();
        loadGoogleMapsScript(apiKey);
      }
      
      // æ¸…é™¤ç¼“å­˜çš„ API key
      function clearApiKey() {
        localStorage.removeItem(STORAGE_KEY);
        document.getElementById('api-key-input').value = '';
        alert('API Key å·²æ¸…é™¤ï¼Œé¡µé¢å°†åˆ·æ–°');
        location.reload();
      }
      
      // åŠ¨æ€åŠ è½½ Google Maps è„šæœ¬
      function loadGoogleMapsScript(apiKey) {
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&v=alpha&libraries=maps3d&callback=init`;
        script.async = true;
        script.defer = true;
        script.onerror = () => {
          console.error('âŒ Google Maps è„šæœ¬åŠ è½½å¤±è´¥');
          document.getElementById('info').innerHTML = `
            <h3>âŒ åŠ è½½å¤±è´¥</h3>
            <p>æ— æ³•åŠ è½½ Google Maps è„šæœ¬ï¼Œè¯·æ£€æŸ¥ API Key æ˜¯å¦æ­£ç¡®</p>
            <button onclick="showApiKeyInput()" style="margin-top: 10px; padding: 8px 16px; cursor: pointer;">
              é‡æ–°è¾“å…¥ API Key
            </button>
          `;
        };
        document.head.appendChild(script);
      }
      
      // åˆå§‹åŒ– 3D åœ°å›¾
      async function init() {
        console.log('ğŸš€ åˆå§‹åŒ– 3D åœ°å›¾...');
        
        try {
          // æ£€æŸ¥ Google Maps API æ˜¯å¦åŠ è½½
          if (!window.google || !window.google.maps) {
            throw new Error('Google Maps API æœªåŠ è½½');
          }
          console.log('âœ… Google Maps API å·²åŠ è½½');
          
          if (!window.google.maps.importLibrary) {
            throw new Error('importLibrary æ–¹æ³•ä¸å¯ç”¨');
          }
          console.log('âœ… importLibrary æ–¹æ³•å¯ç”¨');
          
          // å¯¼å…¥ maps3d åº“
          console.log('ğŸ“¦ æ­£åœ¨å¯¼å…¥ maps3d åº“...');
          const maps3dLib = await google.maps.importLibrary("maps3d");
          console.log('âœ… maps3d åº“å¯¼å…¥ç»“æœ:', maps3dLib);
          
          // æ£€æŸ¥æ˜¯å¦æœ‰ Map3DElement å’Œ Marker3DElement
          if (!maps3dLib.Map3DElement) {
            throw new Error('Map3DElement ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥ API Key å’Œ Map Tiles API æ˜¯å¦å¯ç”¨');
          }
          if (!maps3dLib.Marker3DElement) {
            throw new Error('Marker3DElement ä¸å¯ç”¨');
          }
          
          const { Map3DElement, Marker3DElement } = maps3dLib;
          console.log('âœ… Map3DElement å’Œ Marker3DElement å·²è·å–');
          
          // åˆ›å»º 3D åœ°å›¾
          const map = new Map3DElement({
            center: { 
              lat: 37.8199, 
              lng: -122.4783, 
              altitude: 0 
            },
            tilt: 67.5,
            range: 1500,
            heading: 330,
            mode: 'SATELLITE'  // å¯é€‰: SATELLITE, HYBRID, UNLIT
          });
          console.log('âœ… 3D åœ°å›¾åˆ›å»ºæˆåŠŸ');
          
          // åˆ›å»ºå¤šä¸ªæ ‡è®°
          
          // æ ‡è®° 1: é‡‘é—¨å¤§æ¡¥åŒ—ç«¯
          const marker1 = new Marker3DElement({
            position: { 
              lat: 37.8199, 
              lng: -122.4783, 
              altitude: 100 
            },
            altitudeMode: "ABSOLUTE",
            extruded: true,
            label: "ğŸŒ‰ é‡‘é—¨å¤§æ¡¥åŒ—ç«¯"
          });
          console.log('âœ… æ ‡è®° 1 åˆ›å»ºæˆåŠŸ');
          
          // æ ‡è®° 2: é‡‘é—¨å¤§æ¡¥å—ç«¯
          const marker2 = new Marker3DElement({
            position: { 
              lat: 37.8089, 
              lng: -122.4755, 
              altitude: 80 
            },
            altitudeMode: "ABSOLUTE",
            extruded: true,
            label: "ğŸŒ‰ é‡‘é—¨å¤§æ¡¥å—ç«¯"
          });
          console.log('âœ… æ ‡è®° 2 åˆ›å»ºæˆåŠŸ');
          
          // æ ‡è®° 3: æ›´é«˜çš„æ ‡è®°
          const marker3 = new Marker3DElement({
            position: { 
              lat: 37.8144, 
              lng: -122.4769, 
              altitude: 200 
            },
            altitudeMode: "ABSOLUTE",
            extruded: true,
            label: "ğŸ“ é«˜å¤„è§‚æ™¯ç‚¹"
          });
          console.log('âœ… æ ‡è®° 3 åˆ›å»ºæˆåŠŸ');
          
          // æ ‡è®° 4: åœ°é¢æ ‡è®°ï¼ˆCLAMP_TO_GROUNDï¼‰
          const marker4 = new Marker3DElement({
            position: { 
              lat: 37.8250, 
              lng: -122.4800, 
              altitude: 0 
            },
            altitudeMode: "CLAMP_TO_GROUND",
            extruded: false,
            label: "ğŸ–ï¸ åœ°é¢ç‚¹"
          });
          console.log('âœ… æ ‡è®° 4 åˆ›å»ºæˆåŠŸ');
          
          // å°†æ‰€æœ‰æ ‡è®°æ·»åŠ åˆ°åœ°å›¾
          map.append(marker1);
          map.append(marker2);
          map.append(marker3);
          map.append(marker4);
          console.log('âœ… æ‰€æœ‰æ ‡è®°å·²æ·»åŠ åˆ°åœ°å›¾');
          
          // å°†åœ°å›¾æ·»åŠ åˆ°é¡µé¢
          document.getElementById('map-container').appendChild(map);
          console.log('âœ… åœ°å›¾å·²æ·»åŠ åˆ°é¡µé¢');
          
          console.log('ğŸ‰ 3D åœ°å›¾å’Œæ ‡è®°åˆå§‹åŒ–å®Œæˆï¼');
          
          // å¯é€‰ï¼šæ·»åŠ åœ°å›¾äº¤äº’ç›‘å¬
          map.addEventListener('gmp-click', (event) => {
            console.log('ğŸ–±ï¸ åœ°å›¾è¢«ç‚¹å‡»:', event);
          });
          
        } catch (error) {
          console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
          document.getElementById('info').innerHTML = `
            <h3>âŒ åŠ è½½å¤±è´¥</h3>
            <p>${error.message}</p>
            <button onclick="showApiKeyInput()" style="margin-top: 10px; padding: 8px 16px; cursor: pointer; background: #4285f4; color: white; border: none; border-radius: 5px;">
              é‡æ–°è¾“å…¥ API Key
            </button>
          `;
        }
      }
      
      // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦æœ‰ç¼“å­˜çš„ API key
      window.addEventListener('DOMContentLoaded', () => {
        const apiKey = getApiKey();
        
        if (apiKey) {
          console.log('âœ… æ‰¾åˆ°ç¼“å­˜çš„ API Key');
          loadGoogleMapsScript(apiKey);
        } else {
          console.log('âŒ æœªæ‰¾åˆ°ç¼“å­˜çš„ API Keyï¼Œæ˜¾ç¤ºè¾“å…¥ç•Œé¢');
          showApiKeyInput();
        }
      });
      
      // å…è®¸åœ¨è¾“å…¥æ¡†ä¸­æŒ‰ Enter é”®æäº¤
      document.addEventListener('DOMContentLoaded', () => {
        const input = document.getElementById('api-key-input');
        input.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            saveApiKey();
          }
        });
      });
    </script>
  </body>
</html>

