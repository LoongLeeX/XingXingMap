# Google Maps 应用开发计划

## 1. 项目概述

基于 React、Next.js 和 Google Maps SDK 开发一个功能完整的地图标记应用，支持地址搜索、标记管理、卫星视图切换以及 2D/3D 对比视图。

**开发环境**: 全程在本地 Mac (macOS) 上开发和测试，使用本地数据库和本地文件存储。

## 2. 技术栈

### 前端技术
- **框架**: Next.js 14+ (App Router)
- **UI 库**: React 18+
- **地图 SDK**: 
  - Google Maps JavaScript API
  - Google Maps 3D (Photorealistic 3D Tiles)
- **状态管理**: React Context API / Zustand
- **样式**: Tailwind CSS
- **类型检查**: TypeScript
- **图片上传**: React Dropzone

### 后端技术
- **框架**: Next.js API Routes
- **数据库**: SQLite (开发环境，易于切换)
- **ORM**: Prisma
- **架构模式**: Repository Pattern (数据访问层抽象)
- **文件存储**: 本地文件系统存储
- **认证**: NextAuth.js (可选)
- **开发环境**: macOS 本地开发和测试

> **架构优势**: 使用 Repository Pattern 封装数据访问层，未来可无缝切换到 PostgreSQL、MySQL 等其他数据库，无需修改业务逻辑代码。

### 共享代码
- TypeScript 类型定义
- 数据验证 Schema (Zod)
- 工具函数
- 常量定义

## 3. 目录结构

```
Map/
├── client/                      # 前端代码
│   ├── public/                  # 静态资源
│   ├── src/
│   │   ├── app/                # Next.js App Router
│   │   │   ├── page.tsx        # 主页面
│   │   │   ├── layout.tsx      # 布局
│   │   │   └── globals.css     # 全局样式
│   │   │
│   │   ├── features/           # 前端功能模块（按业务垂直切片）
│   │   │   ├── map/            # 地图功能
│   │   │   │   ├── components/
│   │   │   │   │   ├── MapContainer.tsx
│   │   │   │   │   ├── Map2D.tsx
│   │   │   │   │   ├── Map3D.tsx
│   │   │   │   │   ├── MapControls.tsx
│   │   │   │   │   ├── MapTypeToggle.tsx
│   │   │   │   │   └── SplitView.tsx
│   │   │   │   ├── hooks/
│   │   │   │   │   ├── useGoogleMaps.ts
│   │   │   │   │   ├── useMapInstance.ts
│   │   │   │   │   ├── useMapStore.ts
│   │   │   │   │   └── use3DMap.ts
│   │   │   │   ├── utils/
│   │   │   │   │   ├── map-helpers.ts
│   │   │   │   │   └── map-config.ts
│   │   │   │   └── types/
│   │   │   │       └── map.types.ts
│   │   │   │
│   │   │   ├── markers/        # 标记功能
│   │   │   │   ├── components/
│   │   │   │   │   ├── CustomMarker.tsx
│   │   │   │   │   ├── MarkerInfoWindow.tsx
│   │   │   │   │   ├── MarkerForm.tsx
│   │   │   │   │   ├── MarkerList.tsx
│   │   │   │   │   └── MarkerCard.tsx
│   │   │   │   ├── hooks/
│   │   │   │   │   ├── useMarkers.ts
│   │   │   │   │   ├── useMarkerForm.ts
│   │   │   │   │   ├── useMarkerMutations.ts
│   │   │   │   │   └── useMarkerStore.ts
│   │   │   │   ├── api/
│   │   │   │   │   └── marker-client.ts
│   │   │   │   └── types/
│   │   │   │       └── marker-form.types.ts
│   │   │   │
│   │   │   ├── search/         # 搜索功能
│   │   │   │   ├── components/
│   │   │   │   │   ├── SearchBar.tsx
│   │   │   │   │   ├── SearchResults.tsx
│   │   │   │   │   └── SearchAutocomplete.tsx
│   │   │   │   ├── hooks/
│   │   │   │   │   ├── useGeocoding.ts
│   │   │   │   │   ├── useSearch.ts
│   │   │   │   │   └── useAutocomplete.ts
│   │   │   │   └── api/
│   │   │   │       └── geocoding-client.ts
│   │   │   │
│   │   │   └── upload/         # 文件上传功能
│   │   │       ├── components/
│   │   │       │   ├── ImageUpload.tsx
│   │   │       │   ├── ImagePreview.tsx
│   │   │       │   └── UploadProgress.tsx
│   │   │       ├── hooks/
│   │   │       │   ├── useImageUpload.ts
│   │   │       │   └── useFileValidation.ts
│   │   │       └── utils/
│   │   │           └── image-helpers.ts
│   │   │
│   │   ├── components/         # 通用 UI 组件
│   │   │   └── ui/
│   │   │       ├── Button.tsx
│   │   │       ├── Input.tsx
│   │   │       ├── Modal.tsx
│   │   │       └── Card.tsx
│   │   │
│   │   └── lib/                # 客户端工具库
│   │       ├── api-client.ts
│   │       └── utils.ts
│   │
│   ├── next.config.js
│   ├── package.json
│   ├── tsconfig.json
│   └── tailwind.config.js
│
├── server/                      # 后端代码
│   ├── src/
│   │   ├── features/           # 后端功能模块（按业务垂直切片）
│   │   │   ├── markers/
│   │   │   │   ├── actions/    # Server Actions
│   │   │   │   │   ├── create-marker.ts
│   │   │   │   │   ├── update-marker.ts
│   │   │   │   │   ├── delete-marker.ts
│   │   │   │   │   └── get-markers.ts
│   │   │   │   ├── services/   # 业务逻辑
│   │   │   │   │   ├── marker.service.ts
│   │   │   │   │   └── marker-validation.ts
│   │   │   │   └── repository/ # 数据访问层
│   │   │   │       └── marker.repository.ts
│   │   │   │
│   │   │   └── upload/
│   │   │       ├── actions/
│   │   │       │   └── upload-image.ts
│   │   │       ├── services/
│   │   │       │   ├── upload.service.ts
│   │   │       │   ├── image-processor.ts
│   │   │       │   └── storage.service.ts
│   │   │       └── utils/
│   │   │           └── file-validators.ts
│   │   │
│   │   ├── api/                # API Routes (REST API)
│   │   │   ├── markers/
│   │   │   │   └── route.ts
│   │   │   └── upload/
│   │   │       └── route.ts
│   │   │
│   │   └── lib/                # 服务端工具库
│   │       ├── prisma.ts       # Prisma 客户端
│   │       └── config.ts       # 配置
│   │
│   ├── prisma/
│   │   └── schema.prisma
│   └── package.json
│
├── clientservershare/           # 共享代码
│   ├── types/
│   │   ├── marker.types.ts     # 标记类型定义
│   │   ├── map.types.ts        # 地图类型定义
│   │   └── api.types.ts        # API 接口类型
│   ├── schemas/
│   │   ├── marker.schema.ts    # 标记验证 Schema (Zod)
│   │   └── upload.schema.ts    # 上传验证 Schema
│   ├── constants/
│   │   ├── map.constants.ts    # 地图常量
│   │   └── app.constants.ts    # 应用常量
│   └── utils/
│       └── shared.utils.ts     # 共享工具函数
│
├── .env.local                   # 环境变量
├── .gitignore
├── package.json                 # 根 package.json (monorepo)
└── README.md
```

## 4. Features 架构说明

### 4.1 什么是 Features？

**Features 是按业务功能模块组织的代码**，每个 feature 是一个独立的"垂直切片"，包含该功能从前端到后端的所有代码。

### 4.2 Client Features vs Server Features

#### Client Features（`client/src/features/`）

**职责**: 前端业务逻辑和 UI 展示

**包含内容**:
- `components/` - 功能专属的 UI 组件
- `hooks/` - 功能专属的 React Hooks
- `api/` - API 调用封装（调用后端服务）
- `utils/` - 功能专属的工具函数
- `types/` - 功能专属的类型（可选，大部分类型在 shared）

**示例**:
```
client/src/features/markers/
├── components/      # 标记相关的 UI
│   ├── MarkerForm.tsx
│   └── MarkerList.tsx
├── hooks/           # 标记相关的客户端逻辑
│   ├── useMarkers.ts
│   └── useMarkerForm.ts
└── api/             # 调用后端 API
    └── marker-client.ts
```

#### Server Features（`server/src/features/`）

**职责**: 后端业务逻辑和数据处理

**包含内容**:
- `actions/` - Next.js Server Actions（推荐使用）
- `services/` - 业务逻辑层
- `repository/` - 数据访问层（与数据库交互）
- `utils/` - 功能专属的服务端工具函数

**示例**:
```
server/src/features/markers/
├── actions/         # Server Actions（客户端直接调用）
│   ├── create-marker.ts
│   └── get-markers.ts
├── services/        # 业务逻辑
│   └── marker.service.ts
└── repository/      # 数据库操作
    └── marker.repository.ts
```

### 4.3 数据流向示例

以"创建标记"为例：

```
用户点击创建
    ↓
[Client] MarkerForm.tsx
    ↓
[Client] useMarkerForm.ts (调用 Server Action)
    ↓
[Server] create-marker.ts (Server Action)
    ↓
[Server] marker.service.ts (业务验证)
    ↓
[Server] marker.repository.ts (数据库操作)
    ↓
[Database] Prisma → PostgreSQL
```

### 4.4 Features 的优势

1. **高内聚**: 一个功能的所有相关代码都在一起
2. **低耦合**: 不同 feature 之间相互独立
3. **易维护**: 修改某个功能时，只需关注对应的 feature 目录
4. **易扩展**: 新增功能时，只需创建新的 feature 目录
5. **易删除**: 删除功能时，直接删除对应的 feature 目录即可

### 4.5 通用组件 vs Feature 组件

**通用 UI 组件** → `client/src/components/ui/`
- Button, Input, Modal, Card 等
- 可在任何地方复用

**Feature 专属组件** → `client/src/features/[feature]/components/`
- 仅在该功能中使用
- 与该功能强相关

## 5. 功能需求详细分解

### 5.1 地址搜索与缩放 (Feature 1)
**功能模块**: `client/src/features/search/`

**相关文件**:
- 组件: `SearchBar.tsx`, `SearchAutocomplete.tsx`
- Hooks: `useSearch.ts`, `useGeocoding.ts`, `useAutocomplete.ts`
- API: `geocoding-client.ts`

**功能描述**:
- 提供搜索输入框
- 集成 Google Places Autocomplete API
- 搜索结果选择后自动缩放到目标位置
- 支持地理编码和反向地理编码
- 保存搜索历史

**技术实现**:
```typescript
// client/src/features/search/hooks/useAutocomplete.ts
const autocomplete = new google.maps.places.Autocomplete(input);
autocomplete.addListener('place_changed', () => {
  const place = autocomplete.getPlace();
  map.setCenter(place.geometry.location);
  map.setZoom(18);
});
```

**API 需求**:
- Google Places API
- Google Geocoding API

### 5.2 标记管理 (Feature 2)
**功能模块**: 
- 前端: `client/src/features/markers/`
- 后端: `server/src/features/markers/`

**相关文件**:
- **客户端**:
  - 组件: `MarkerForm.tsx`, `MarkerList.tsx`, `MarkerCard.tsx`, `CustomMarker.tsx`
  - Hooks: `useMarkers.ts`, `useMarkerForm.ts`, `useMarkerMutations.ts`
  - API: `marker-client.ts`
- **服务端**:
  - Actions: `create-marker.ts`, `update-marker.ts`, `delete-marker.ts`, `get-markers.ts`
  - Services: `marker.service.ts`, `marker-validation.ts`
  - Repository: `marker.repository.ts`

**功能描述**:
- 点击地图选择位置
- 添加文本描述
- 上传图片（支持多张）
- 保存标记到数据库
- 显示已有标记
- 编辑/删除标记

**数据结构**:
```typescript
// clientservershare/types/marker.types.ts
interface Marker {
  id: string;
  position: {
    lat: number;
    lng: number;
  };
  title?: string;
  description?: string;
  imageUrl?: string;
  createdAt: Date;
  updatedAt: Date;
}
```

**数据流**:
```
用户操作
  ↓
MarkerForm (client/features/markers/components/)
  ↓
useMarkerForm (client/features/markers/hooks/)
  ↓
createMarker (server/features/markers/actions/)
  ↓
MarkerService (server/features/markers/services/)
  ↓
MarkerRepository (server/features/markers/repository/)
  ↓
Prisma → Database
```

**API 端点**:
- Server Actions (推荐):
  - `createMarker(data)` - 创建标记
  - `updateMarker(id, data)` - 更新标记
  - `deleteMarker(id)` - 删除标记
  - `getMarkers()` - 获取标记列表
- REST API (备选):
  - `POST /api/markers`
  - `GET /api/markers`
  - `PUT /api/markers/:id`
  - `DELETE /api/markers/:id`

### 5.3 卫星视图切换 (Feature 3)
**功能模块**: `client/src/features/map/`

**相关文件**:
- 组件: `MapTypeToggle.tsx`, `MapControls.tsx`
- Hooks: `useMapControls.ts`

**功能描述**:
- 提供视图切换按钮
- 支持地图类型切换：roadmap、satellite、hybrid、terrain

**技术实现**:
```typescript
// client/src/features/map/components/MapTypeToggle.tsx
map.setMapTypeId(google.maps.MapTypeId.SATELLITE);
```

### 5.4 2D/3D 对比视图 (Feature 4)
**功能模块**: `client/src/features/map/`

**相关文件**:
- 组件: `SplitView.tsx`, `Map2D.tsx`, `Map3D.tsx`, `View3DToggle.tsx`
- Hooks: `use3DMap.ts`, `useMapInstance.ts`

**功能描述**:
- 点击"显示 3D"按钮后，界面分屏显示
- 左侧：2D 卫星视图（传统 Google Maps）
- 右侧：3D 视图（Photorealistic 3D Tiles）
- 两个视图可以独立缩放和平移
- 可选：同步两个视图的中心点

**技术实现**:
```typescript
// client/src/features/map/components/Map2D.tsx
const map2D = new google.maps.Map(container2D, {
  mapTypeId: 'satellite'
});

// client/src/features/map/components/Map3D.tsx
const map3D = new google.maps.Map(container3D, {
  mapId: 'YOUR_3D_MAP_ID', // 需要在 Google Cloud Console 配置
  center: { lat, lng },
  zoom: 18,
  tilt: 47.5,
  heading: 0
});
```

**布局**:
- CSS Grid 或 Flexbox 实现左右分屏
- 响应式设计，移动端上下布局

### 5.5 文件上传功能
**功能模块**:
- 前端: `client/src/features/upload/`
- 后端: `server/src/features/upload/`

**相关文件**:
- **客户端**:
  - 组件: `ImageUpload.tsx`, `ImagePreview.tsx`, `UploadProgress.tsx`
  - Hooks: `useImageUpload.ts`, `useFileValidation.ts`
- **服务端**:
  - Actions: `upload-image.ts`
  - Services: `upload.service.ts`, `image-processor.ts`, `storage.service.ts`

**功能描述**:
- 图片选择和预览
- 图片压缩和优化
- 上传进度显示
- 支持拖拽上传
- 文件类型和大小验证

## 6. 实施阶段

### Phase 1: 项目初始化 (1-2 天)
**本地 Mac 环境准备**:
- [ ] 安装 Node.js (v18+) 和 npm/pnpm
- [ ] 安装 PostgreSQL (使用 Homebrew: `brew install postgresql@15`) 或使用 SQLite
- [ ] 创建 Next.js 项目结构
- [ ] 配置 TypeScript
- [ ] 安装依赖包
- [ ] 配置 Tailwind CSS
- [ ] 设置本地环境变量 (.env.local)
- [ ] 初始化本地数据库
- [ ] 配置 Google Maps API Key
- [ ] 创建本地图片存储目录

### Phase 2: 基础地图功能 (3-4 天)
- [ ] 实现基础地图展示
- [ ] 集成 Google Maps SDK
- [ ] 实现地址搜索功能
- [ ] 实现地图缩放和平移
- [ ] 实现卫星视图切换
- [ ] 添加地图控件

### Phase 3: 标记功能 (4-5 天)
- [ ] 实现点击地图添加标记
- [ ] 创建标记表单组件
- [ ] 实现文本描述功能
- [ ] 实现图片上传功能
- [ ] 实现图片预览
- [ ] 设计标记数据库模型
- [ ] 实现标记 CRUD API
- [ ] 实现标记列表显示
- [ ] 实现标记编辑和删除

### Phase 4: 3D 功能 (3-4 天)
- [ ] 配置 Google Maps 3D
- [ ] 实现 3D 地图渲染
- [ ] 实现分屏对比视图
- [ ] 实现独立缩放控制
- [ ] 优化 3D 性能
- [ ] 处理 3D 不可用区域的降级方案

### Phase 5: 优化与测试 (2-3 天)
- [ ] 性能优化
- [ ] 响应式设计优化
- [ ] 错误处理
- [ ] 加载状态优化
- [ ] 跨浏览器测试
- [ ] 移动端适配
- [ ] 编写文档

### Phase 6: 本地测试与优化 (1 天)
- [ ] 在本地 Mac 上进行完整的端到端测试
- [ ] 验证所有功能在 localhost 环境下正常运行
- [ ] 测试数据库连接和数据持久化
- [ ] 验证图片上传和本地存储
- [ ] 性能监控和优化
- [ ] 编写本地部署和运行文档

**总预计时间**: 14-19 天
**开发环境**: 全程在本地 Mac 上开发和测试

## 7. 数据库设计

### 数据库方案: SQLite

**选择理由**:
- ✅ 零配置，无需额外安装数据库服务
- ✅ 文件数据库，易于备份和版本控制
- ✅ 适合本地开发和测试
- ✅ 性能足够满足当前需求
- ✅ 通过 Repository Pattern 封装，未来可轻松切换

**切换能力**:
- 通过接口抽象，可无缝切换到 PostgreSQL、MySQL、MongoDB
- 只需修改数据库连接配置和 Prisma Schema
- 业务逻辑代码无需改动

### Markers 表
```prisma
model Marker {
  id          String   @id @default(cuid())
  title       String
  description String?
  latitude    Float
  longitude   Float
  images      String[] // 图片 URL 数组（本地路径: /uploads/xxx.jpg）
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
```

**注意**: `images` 字段存储的是本地相对路径，如 `/uploads/image-123.jpg`

### Repository Pattern 架构设计

为了实现数据库无关的业务逻辑，采用 **Repository Pattern** 封装数据访问层。

#### 架构分层

```
Controller (API/Server Actions)
         ↓
Service Layer (业务逻辑)
         ↓
Repository Interface (接口定义)
         ↓
Repository Implementation (具体实现)
         ↓
Database (SQLite / PostgreSQL / etc.)
```

#### Repository 接口示例

```typescript
// server/src/features/markers/repository/marker.repository.interface.ts
export interface IMarkerRepository {
  // 创建标记
  create(data: CreateMarkerInput): Promise<Marker>;
  
  // 查询所有标记
  findAll(): Promise<Marker[]>;
  
  // 根据 ID 查询
  findById(id: string): Promise<Marker | null>;
  
  // 更新标记
  update(id: string, data: UpdateMarkerInput): Promise<Marker>;
  
  // 删除标记
  delete(id: string): Promise<void>;
  
  // 根据坐标范围查询
  findByBounds(bounds: MapBounds): Promise<Marker[]>;
}
```

#### Prisma 实现示例

```typescript
// server/src/features/markers/repository/marker.repository.prisma.ts
import { PrismaClient } from '@prisma/client';
import { IMarkerRepository } from './marker.repository.interface';

export class PrismaMarkerRepository implements IMarkerRepository {
  constructor(private prisma: PrismaClient) {}
  
  async create(data: CreateMarkerInput): Promise<Marker> {
    return this.prisma.marker.create({ data });
  }
  
  async findAll(): Promise<Marker[]> {
    return this.prisma.marker.findMany({
      orderBy: { createdAt: 'desc' }
    });
  }
  
  async findById(id: string): Promise<Marker | null> {
    return this.prisma.marker.findUnique({ where: { id } });
  }
  
  async update(id: string, data: UpdateMarkerInput): Promise<Marker> {
    return this.prisma.marker.update({ where: { id }, data });
  }
  
  async delete(id: string): Promise<void> {
    await this.prisma.marker.delete({ where: { id } });
  }
  
  async findByBounds(bounds: MapBounds): Promise<Marker[]> {
    return this.prisma.marker.findMany({
      where: {
        latitude: { gte: bounds.south, lte: bounds.north },
        longitude: { gte: bounds.west, lte: bounds.east }
      }
    });
  }
}
```

#### Service 层使用 Repository

```typescript
// server/src/features/markers/services/marker.service.ts
import { IMarkerRepository } from '../repository/marker.repository.interface';

export class MarkerService {
  constructor(private markerRepo: IMarkerRepository) {}
  
  async createMarker(data: CreateMarkerInput) {
    // 业务验证逻辑
    this.validateMarkerData(data);
    
    // 调用 Repository
    return this.markerRepo.create(data);
  }
  
  async getAllMarkers() {
    return this.markerRepo.findAll();
  }
  
  // ... 其他业务方法
}
```

#### 依赖注入配置

```typescript
// server/src/lib/repository-factory.ts
import { PrismaClient } from '@prisma/client';
import { PrismaMarkerRepository } from '../features/markers/repository/marker.repository.prisma';

const prisma = new PrismaClient();

// 工厂函数：创建 Repository 实例
export const createMarkerRepository = () => {
  return new PrismaMarkerRepository(prisma);
};

// 未来切换数据库时，只需修改这里
// export const createMarkerRepository = () => {
//   return new MongoMarkerRepository(mongoClient);
// };
```

#### 切换数据库步骤

当需要从 SQLite 切换到 PostgreSQL 时：

1. **修改 Prisma Schema**:
   ```prisma
   // prisma/schema.prisma
   datasource db {
     provider = "postgresql"  // 从 "sqlite" 改为 "postgresql"
     url      = env("DATABASE_URL")
   }
   ```

2. **修改环境变量**:
   ```env
   DATABASE_URL="postgresql://user:pass@localhost:5432/dbname"
   ```

3. **运行数据迁移**:
   ```bash
   npx prisma migrate dev
   ```

4. **业务代码无需修改** ✅
   - Service 层代码不变
   - Repository 接口不变
   - Repository 实现可能需要微调（如果有数据库特定功能）

#### Repository Pattern 优势

1. **数据库无关**: 业务逻辑不依赖具体数据库
2. **易于测试**: 可以 Mock Repository 接口进行单元测试
3. **灵活切换**: 切换数据库只需替换 Repository 实现
4. **统一接口**: 所有数据访问通过统一接口，代码更清晰
5. **可扩展**: 可以添加缓存层、日志层等中间件

## 8. API 设计

### 8.1 创建标记
```
POST /api/markers
Content-Type: application/json

{
  "title": "我的标记",
  "description": "这是描述",
  "latitude": 39.9042,
  "longitude": 116.4074,
  "images": ["url1", "url2"]
}

Response: 201
{
  "id": "marker_id",
  "title": "我的标记",
  ...
}
```

### 8.2 获取标记列表
```
GET /api/markers

Response: 200
{
  "markers": [...]
}
```

### 8.3 上传图片
```
POST /api/upload
Content-Type: multipart/form-data

Response: 200
{
  "url": "https://..."
}
```

## 9. 关键技术点

### 9.1 Google Maps API Key 配置
需要启用以下 API：
- Maps JavaScript API
- Places API
- Geocoding API
- Map Tiles API (for 3D)

### 9.2 3D Maps 配置
1. 在 Google Cloud Console 创建 Map ID
2. 启用 3D 功能
3. 配置地图样式

### 9.3 图片处理
- 客户端压缩（使用 browser-image-compression）
- 服务端验证
- 存储优化（WebP 格式）
- CDN 加速

### 9.4 性能优化
- 地图懒加载
- 标记聚类（MarkerClusterer）
- 图片懒加载
- 虚拟滚动（标记列表）
- 代码分割

## 10. 本地 Mac 环境变量配置

```env
# .env.local (本地开发配置)

# Google Maps API Key
NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=your_api_key
NEXT_PUBLIC_GOOGLE_MAPS_MAP_ID=your_3d_map_id  # 用于 3D 地图

# 数据库配置 - SQLite
DATABASE_URL=file:./dev.db

# 本地文件存储
UPLOAD_DIR=./public/uploads  # 存储在 public 目录，可通过 URL 访问
MAX_FILE_SIZE=5242880  # 5MB
ALLOWED_FILE_TYPES=image/jpeg,image/png,image/webp

# 开发环境配置
NODE_ENV=development
PORT=3000  # 本地开发端口
```

### 本地数据库初始化命令

**SQLite 初始化**:
```bash
# SQLite 无需额外安装，直接运行迁移即可
npx prisma migrate dev --name init

# 查看数据库内容
npx prisma studio

# 数据库文件位置: ./dev.db
```

**切换到 PostgreSQL** (未来如需):
```bash
# 1. 安装 PostgreSQL
brew install postgresql@15
brew services start postgresql@15

# 2. 创建数据库
createdb map_dev

# 3. 修改 .env.local
# DATABASE_URL="postgresql://localhost:5432/map_dev?schema=public"

# 4. 修改 prisma/schema.prisma
# provider = "postgresql"

# 5. 运行迁移
npx prisma migrate dev
```

## 11. 风险与挑战

### 技术风险
1. **3D 地图覆盖范围**: 3D 数据不是全球覆盖，需要处理降级方案
2. **API 配额限制**: Google Maps API 有使用限制，需要监控使用量
3. **性能问题**: 大量标记时需要优化渲染性能
4. **移动端兼容性**: 3D 功能在移动设备上可能性能受限

### 本地开发注意事项
1. **磁盘空间**: 图片存储在本地，需要定期清理测试数据
2. **数据备份**: 定期备份本地数据库文件（SQLite: `dev.db`，PostgreSQL: 使用 `pg_dump`）
3. **端口冲突**: 确保 3000 端口未被占用，或修改默认端口
4. **API Key 安全**: `.env.local` 不要提交到 Git，保护 API Key
5. **浏览器缓存**: 开发时可能需要清除浏览器缓存查看最新效果

## 12. 后续扩展功能

- 用户认证和授权
- 标记分类和标签
- 标记搜索和过滤
- 分享标记功能
- 导出标记数据
- 路线规划
- 街景视图集成
- 多用户协作

## 13. 参考资源

- [Google Maps JavaScript API](https://developers.google.com/maps/documentation/javascript)
- [Google Maps 3D Documentation](https://developers.google.com/maps/documentation/javascript/3d-tiles)
- [Next.js Documentation](https://nextjs.org/docs)
- [Prisma Documentation](https://www.prisma.io/docs)

## 14. 架构亮点总结

### 14.1 Features 驱动开发

本项目采用 **Features 驱动的架构**，具有以下优势：

1. **清晰的职责分离**
   - Client Features: 负责 UI 和用户交互
   - Server Features: 负责业务逻辑和数据处理
   - Shared: 负责类型定义和共享代码

2. **模块化设计**
   ```
   每个 Feature = 一个完整的业务功能模块
   - 独立开发
   - 独立测试
   - 独立部署（微前端场景）
   ```

3. **团队协作友好**
   - 不同开发人员可以并行开发不同的 features
   - 减少代码冲突
   - 易于代码审查

4. **易于维护和扩展**
   - 新增功能：创建新的 feature 目录
   - 修改功能：只需关注对应的 feature
   - 删除功能：直接删除 feature 目录

### 14.2 技术选型理由

- **Next.js 14+**: 全栈开发，Server Actions 简化前后端交互
- **TypeScript**: 类型安全，减少运行时错误
- **Prisma**: 现代化 ORM，类型安全的数据库操作
- **Tailwind CSS**: 快速构建现代 UI
- **Zustand**: 轻量级状态管理
- **Zod**: 运行时类型验证，前后端共享验证逻辑

### 14.3 项目结构对比

**传统结构**:
```
❌ 功能分散，难以维护
src/
├── components/     # 所有组件混在一起
├── hooks/          # 所有 hooks 混在一起
├── services/       # 所有服务混在一起
└── api/            # 所有 API 混在一起
```

**Features 结构**:
```
✅ 功能聚合，易于维护
client/src/features/
├── map/            # 地图功能的所有代码
├── markers/        # 标记功能的所有代码
└── search/         # 搜索功能的所有代码

server/src/features/
├── markers/        # 标记功能的后端代码
└── upload/         # 上传功能的后端代码
```

---

**计划制定日期**: 2025-10-03
**预计开始日期**: 待定
**预计完成日期**: 待定

---

## 附录：快速开始指南

### 创建新 Feature 的步骤

1. **创建客户端 Feature**
   ```bash
   mkdir -p client/src/features/my-feature/{components,hooks,api}
   ```

2. **创建服务端 Feature**
   ```bash
   mkdir -p server/src/features/my-feature/{actions,services,repository}
   ```

3. **添加共享类型**
   ```bash
   touch clientservershare/types/my-feature.types.ts
   touch clientservershare/schemas/my-feature.schema.ts
   ```

4. **实现功能**
   - 先实现服务端（数据层 → 业务层 → Actions）
   - 再实现客户端（API 调用 → Hooks → 组件）

这种架构确保了代码的可维护性、可扩展性和团队协作效率！

---

## 附录 B: 本地 Mac 开发快速启动

### 系统要求
- macOS 10.15+
- Node.js 18.17+ 或 20.0+
- npm 9+ 或 pnpm 8+
- (可选) PostgreSQL 15+ 或使用 SQLite

### 快速启动步骤

1. **安装依赖工具**
   ```bash
   # 安装 Homebrew (如果未安装)
   /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
   
   # 安装 Node.js
   brew install node
   
   # (可选) 安装 PostgreSQL
   brew install postgresql@15
   brew services start postgresql@15
   ```

2. **克隆并初始化项目**
   ```bash
   cd /Users/cocui/i100/kkMy/github/Map
   
   # 安装依赖
   npm install
   # 或使用 pnpm (更快)
   # npm install -g pnpm
   # pnpm install
   ```

3. **配置环境变量**
   ```bash
   # 创建环境变量文件
   cp .env.example .env.local
   
   # 编辑 .env.local，添加你的 Google Maps API Key
   # NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=your_actual_api_key
   ```

4. **初始化数据库**
   ```bash
   # 如果使用 PostgreSQL
   createdb map_dev
   
   # 运行数据库迁移
   npx prisma migrate dev
   
   # 生成 Prisma Client
   npx prisma generate
   ```

5. **创建本地上传目录**
   ```bash
   mkdir -p public/uploads
   ```

6. **启动开发服务器**
   ```bash
   npm run dev
   # 或
   # pnpm dev
   
   # 应用将在 http://localhost:3000 运行
   ```

7. **打开浏览器测试**
   ```
   访问: http://localhost:3000
   ```

### 常用开发命令

```bash
# 启动开发服务器
npm run dev

# 构建生产版本（本地测试生产构建）
npm run build
npm run start

# 数据库相关
npx prisma studio          # 打开数据库可视化界面
npx prisma migrate dev     # 创建新的数据库迁移
npx prisma db push         # 快速同步数据库（开发时使用）

# 代码检查和格式化
npm run lint               # 运行 ESLint
npm run format             # 格式化代码（如果配置了 Prettier）

# TypeScript 类型检查
npx tsc --noEmit
```

### 本地开发调试技巧

1. **查看数据库内容**
   ```bash
   npx prisma studio
   # 在浏览器打开 http://localhost:5555
   ```

2. **查看上传的图片**
   ```
   图片存储在: public/uploads/
   访问路径: http://localhost:3000/uploads/[filename]
   ```

3. **Chrome DevTools 调试**
   - 使用 React DevTools 扩展
   - 使用 Network 标签查看 API 请求
   - 使用 Console 查看 Google Maps API 加载状态

4. **Next.js 开发模式特性**
   - 热重载（Hot Reload）
   - 错误提示（Error Overlay）
   - Fast Refresh

### 故障排查

**问题 1**: Google Maps 不显示
```bash
# 检查 API Key 是否正确配置
echo $NEXT_PUBLIC_GOOGLE_MAPS_API_KEY
# 检查浏览器控制台是否有 API 错误
```

**问题 2**: 数据库连接失败
```bash
# 确保 PostgreSQL 正在运行
brew services list
# 重启 PostgreSQL
brew services restart postgresql@15
```

**问题 3**: 端口被占用
```bash
# 查找占用 3000 端口的进程
lsof -i :3000
# 或更改端口
PORT=3001 npm run dev
```

**问题 4**: 图片上传失败
```bash
# 检查上传目录权限
ls -la public/uploads
# 如果目录不存在，创建它
mkdir -p public/uploads
chmod 755 public/uploads
```

### 本地开发最佳实践

1. **使用 SQLite 快速开发**: 初期开发建议使用 SQLite，无需额外配置
2. **使用 Prisma Studio**: 方便查看和管理数据
3. **启用 TypeScript 严格模式**: 在 `tsconfig.json` 中启用 `strict: true`
4. **使用 Git**: 定期提交代码，保护开发成果
5. **环境变量安全**: 永远不要提交 `.env.local` 到 Git

### macOS 特定优化

1. **使用 pnpm 替代 npm**: 速度更快，节省磁盘空间
2. **使用 nvm 管理 Node 版本**: 
   ```bash
   brew install nvm
   nvm install 20
   nvm use 20
   ```
3. **配置 VS Code**: 安装推荐扩展
   - ESLint
   - Prettier
   - Tailwind CSS IntelliSense
   - Prisma

---

**开发环境**: 全程在本地 Mac (macOS) 上开发和测试
**最后更新**: 2025-10-03
