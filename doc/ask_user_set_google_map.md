
---

## API Key Management Module (API Key 管理模块)

### 5.1 设计目标

设计一个统一的 API Key 管理模块，让用户清楚了解：
- 当前在什么环境下运行（本地 / Vercel）
- API Key 从哪里来（环境变量 / 用户自定义）
- 如何配置和切换 API Key

### 5.2 核心概念

#### 5.2.1 环境隔离原则

**关键理解**：Local ENV 和 Vercel ENV 是**互斥的运行环境**，不是优先级关系。

| 运行场景 | 存在的环境 | 配置来源 |
|---------|----------|---------|
| 本地开发 | LOCAL_ENV | 本地 `.env.local` 文件 |
| Vercel 部署 | VERCEL_ENV | Vercel Dashboard 环境变量 |
| 任何环境 + 用户操作 | USER_SETTINGS | 用户在页面中手动输入 |

#### 5.2.2 三种配置来源

**1. Local Environment (本地环境)**
- 配置方式：创建 `.env.local` 文件，设置 `NEXT_PUBLIC_GOOGLE_MAPS_API_KEY`
- 适用场景：本地开发和测试
- 检测方式：通过环境变量判断不在 Vercel 环境
- 优势：安全、不会提交到代码仓库

**2. Vercel Environment (线上环境)**
- 配置方式：在 Vercel Dashboard 或 CLI 中设置环境变量
- 适用场景：生产环境、预览环境
- 检测方式：检查是否存在 Vercel 特定的环境标识
- 优势：统一管理、支持不同部署环境

**3. User Settings (用户自定义)**
- 配置方式：通过设置页面手动输入
- 适用场景：
  - 本地开发：快速测试不同 API Key，无需修改文件
  - 线上环境：允许用户使用自己的 API Key
- 存储方式：浏览器 localStorage
- 优势：灵活切换、即时生效

#### 5.2.3 配置选择逻辑

简单明了的优先级规则：

```
用户自定义配置 > 当前环境的环境变量
```

**逻辑说明**：
1. 首先检查是否有用户自定义配置
2. 如果有，直接使用（最高优先级）
3. 如果没有，使用当前环境的环境变量
4. 删除用户自定义配置后，自动回退到环境变量

### 5.3 管理界面设计 (Management UI)

#### 5.3.1 API Key 状态面板
在 Settings 页面中添加"API Key 管理"区域，显示：

**设计原则**：
- 清晰展示当前运行环境（本地/Vercel）
- 显示该环境下的环境变量配置状态
- 允许用户添加自定义 API Key 覆盖环境配置

```
┌─────────────────────────────────────────────────────┐
│ 🔑 Google Maps API Key 管理                          │
├─────────────────────────────────────────────────────┤
│                                                       │
│ 当前运行环境                                          │
│ ┌─────────────────────────────────────────────────┐ │
│ │ 💻 本地开发环境 (Local Development)               │ │
│ │ 或                                                │ │
│ │ ☁️ Vercel 线上环境 (Production/Preview)           │ │
│ └─────────────────────────────────────────────────┘ │
│                                                       │
│ 当前使用的 API Key                                    │
│ ┌─────────────────────────────────────────────────┐ │
│ │ 来源: 👤 用户自定义                              │ │
│ │ Key:  AIza...xyz (部分隐藏)                      │ │
│ │ 状态: ✅ 有效                                    │ │
│ │ 配置时间: 2025-10-06 10:30                       │ │
│ │ [测试] [删除] [显示完整 Key]                     │ │
│ └─────────────────────────────────────────────────┘ │
│                                                       │
│ 环境默认配置                                          │
│ ┌─────────────────────────────────────────────────┐ │
│ │ 来源: 💻 Local .env 文件                         │ │
│ │      或 ☁️ Vercel 环境变量                       │ │
│ │ Key:  AIza...abc (部分隐藏)                      │ │
│ │ 状态: ✅ 已配置                                  │ │
│ │ [测试]                                           │ │
│ │                                                   │ │
│ │ ℹ️ 提示: 用户自定义配置会覆盖此环境配置          │ │
│ └─────────────────────────────────────────────────┘ │
│                                                       │
│ [+ 添加自定义 API Key]                               │
└─────────────────────────────────────────────────────┘
```

**无用户自定义配置时**：
```
┌─────────────────────────────────────────────────────┐
│ 🔑 Google Maps API Key 管理                          │
├─────────────────────────────────────────────────────┤
│                                                       │
│ 当前运行环境: 💻 本地开发                             │
│                                                       │
│ 当前使用的 API Key                                    │
│ ┌─────────────────────────────────────────────────┐ │
│ │ 来源: Local .env 文件                            │ │
│ │ Key:  AIza...abc (部分隐藏)                      │ │
│ │ 状态: ✅ 有效                                    │ │
│ │ [测试]                                           │ │
│ └─────────────────────────────────────────────────┘ │
│                                                       │
│ [+ 添加自定义 API Key (可覆盖环境配置)]              │
└─────────────────────────────────────────────────────┘
```

#### 5.3.2 显示内容

**当前运行环境**：
- 自动检测并显示（`process.env.VERCEL === '1'` 判断）
- 图标：💻 本地 / ☁️ Vercel
- 环境类型：Development / Production / Preview（Vercel 特有）

**当前使用的 API Key**（实际生效的配置）：
- **来源标识**: 
  - 👤 用户自定义（USER_SETTINGS）
  - 💻 本地环境变量（LOCAL_ENV）
  - ☁️ Vercel 环境变量（VERCEL_ENV）
- **Key 预览**: 部分显示（如：`AIza...xyz`，前4后3个字符）
- **验证状态**: 
  - ✅ 有效（Valid）
  - ❌ 无效（Invalid）
  - ⏳ 未测试（Untested）
  - ⚠️ 需要验证（Needs Validation）
- **配置时间**: 仅用户自定义显示
- **操作按钮**:
  - **测试**: 验证 API Key 是否有效
  - **删除**: 仅用户自定义可删除（删除后回退到环境配置）
  - **显示完整 Key**: 需二次确认，5秒后自动隐藏

**环境默认配置**（当前环境的环境变量）：
- 仅在有用户自定义配置时显示，作为"备用配置"参考
- 显示当前环境（本地/.env 或 Vercel）的默认 Key 状态
- 操作：仅提供"测试"按钮
- 提示：说明当前被用户自定义覆盖

### 5.4 技术实现思路

#### 5.4.1 数据模型设计

**环境检测**
- 区分两种运行环境：LOCAL (本地) 和 VERCEL (线上)
- 检测方法：查看 Vercel 特定的环境标识
- Vercel 环境细分：production（生产）、preview（预览）、development（开发）

**配置状态模型**
系统需要追踪三种配置状态：
1. **当前生效的配置**：用户实际使用的 API Key
2. **环境默认配置**：当前环境的环境变量配置
3. **用户自定义配置**：用户通过页面设置的配置

每个配置包含的信息：
- 来源类型（环境变量 / 用户自定义）
- API Key 值
- 验证状态（有效/无效/未测试）
- 配置时间（用户自定义特有）

#### 5.4.2 核心模块设计

**API Key Manager（管理器）**
负责所有 API Key 相关的操作：
- 获取当前状态
- 获取生效的 API Key
- 设置/删除用户自定义配置
- 验证 API Key 有效性
- 刷新状态

**状态管理**
使用全局状态管理（如 Zustand）：
- API Key 状态
- 加载状态
- 错误信息
- 操作方法（加载、验证、设置、删除）
- 计算属性（是否有用户自定义、是否使用环境配置等）

#### 5.4.3 环境变量封装（推荐）

**设计目标**：
- 集中管理所有环境变量
- 启动时自动校验
- 提供类型安全访问
- 防止拼写错误
- 区分客户端/服务端变量

让代码从 client/src/lib/env.ts 和 server/src/lib/env.ts  ，不要直接访问 process.env
不要用环境变量判断 运行环境，而是 根本就不要讲变量写入 process.env

**客户端环境变量模块** (`client/src/lib/env.ts`)
- 只包含 `NEXT_PUBLIC_` 前缀的变量
- 提供环境检测工具函数
- 开发环境自动校验和输出诊断信息
- 封装 Google Maps API Key 的读取

**服务端环境变量模块** (`server/src/lib/env.ts`)
- 包含所有服务端变量（数据库、密钥等）
- 启动时强制校验必需变量
- 防止在客户端意外导入

**好处**：
- 类型安全：IDE 自动完成，编译时检查
- 维护性：统一管理，易于扩展
- 安全性：清晰区分客户端/服务端
- 调试：自动诊断，清晰的错误提示

### 5.5 用户体验增强 (UX Enhancements)

#### 5.5.1 首次使用引导
**场景一：本地开发环境，无任何配置**
```
┌─────────────────────────────────────────────────────┐
│ ⚠️ 未检测到 Google Maps API Key                     │
├─────────────────────────────────────────────────────┤
│ 当前环境: 💻 本地开发                                │
│                                                       │
│ 您需要配置 API Key 才能使用地图功能：                │
│                                                       │
│ 方式 1: 在 .env.local 文件中配置（推荐）             │
│ ├─ 添加: NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=YOUR_KEY   │
│ └─ 重启开发服务器                                    │
│                                                       │
│ 方式 2: 在此处直接设置（临时测试用）                 │
│ └─ [+ 添加 API Key]                                  │
│                                                       │
│ [📖 查看配置教程] [🔑 获取 API Key]                 │
└─────────────────────────────────────────────────────┘
```

**场景二：Vercel 环境，无配置**
- 显示如何在 Vercel Dashboard 设置环境变量
- 提供 Vercel 环境变量配置的直达链接
- 说明需要重新部署才能生效

#### 5.5.2 用户自定义覆盖
**使用场景**：
- **本地开发**: 
  - 测试不同的 API Key 而无需修改 `.env` 文件
  - 临时使用其他项目的 Key 进行调试
- **线上环境**:
  - 用户个人的 API Key（如果允许用户使用自己的 Key）
  - 临时切换到备用 Key

**操作流程**：
1. 点击"添加自定义 API Key"
2. 输入 Key 并自动验证
3. 验证通过后立即生效
4. 显示提示："当前使用自定义 API Key，删除后将回退到环境配置"

#### 5.5.3 智能提示

**提示 1: 环境识别**
- 页面加载时显示当前环境标识
- 在本地开发环境显示：💻 本地开发环境
- 在 Vercel 显示：☁️ Vercel Production/Preview

**提示 2: 配置状态**
- ✅ **已配置环境变量，正常使用**
- ⚠️ **正在使用自定义 API Key（覆盖环境配置）**
- ❌ **未配置 API Key，请立即配置**

**提示 3: 操作反馈**
- 添加自定义 Key：Toast 提示"自定义 API Key 已生效"
- 删除自定义 Key：Toast 提示"已回退到环境配置"
- 验证成功：Toast 提示"API Key 验证成功 ✅"
- 验证失败：Toast 提示"API Key 无效，请检查 ❌"

**提示 4: 回退机制**
```
当前使用的自定义 API Key 验证失败
┌─────────────────────────────────────────────────────┐
│ ⚠️ API Key 验证失败                                  │
│                                                       │
│ 您的自定义 API Key 似乎无效或已过期                  │
│                                                       │
│ [保持使用] [切换到环境配置] [重新输入]               │
└─────────────────────────────────────────────────────┘
```

### 5.6 安全增强 (Security Enhancements)

#### 5.6.1 Key 显示规则
- **默认显示**: `AIza...xyz`（前4后3个字符）
- **显示完整 Key**: 
  - 需要点击"显示完整 Key"按钮
  - 弹出确认对话框："确认显示完整 API Key？请确保周围环境安全"
  - 显示后5秒自动重新隐藏
- **复制功能**: 提供"复制"按钮，直接复制完整 Key 到剪贴板

#### 5.6.2 存储安全性

**环境变量配置（推荐）**：
- **Local ENV**: 存储在 `.env.local` 文件（不会提交到 Git）
- **Vercel ENV**: 存储在 Vercel 服务器端环境变量
- **安全等级**: ✅ 高（不会暴露在客户端代码中）
- **注意**: `NEXT_PUBLIC_` 前缀的变量会被打包到客户端代码

**用户自定义配置（临时使用）**：
- **存储位置**: localStorage（客户端浏览器）
- **安全等级**: ⚠️ 中等（存储在用户本地）
- **风险**: 
  - XSS 攻击可能窃取
  - 开发者工具可见
- **建议**: 
  - 仅用于测试和开发
  - 生产环境优先使用环境变量

**安全建议提示**：
```
┌─────────────────────────────────────────────────────┐
│ ⚠️ 安全提示                                          │
│                                                       │
│ 自定义 API Key 存储在浏览器本地，存在以下风险：     │
│ • 可通过浏览器开发者工具查看                         │
│ • XSS 攻击可能导致泄露                               │
│                                                       │
│ 生产环境建议使用环境变量配置 API Key                │
│                                                       │
│ [了解详情] [仍然添加]                                │
└─────────────────────────────────────────────────────┘
```

### 5.7 开发工具和调试

#### 5.7.1 调试模式面板

在开发环境提供可折叠的调试信息面板：

```
┌─────────────────────────────────────────────────────┐
│ 🔧 API Key 调试信息 (仅开发环境)                     │
├─────────────────────────────────────────────────────┤
│ 运行环境检测:                                        │
│ ├─ 检测结果: LOCAL                                  │
│ └─ Node ENV: development                            │
│                                                       │
│ 环境变量: AIza...abc (来自 .env.local)              │
│ 用户自定义: null (未设置)                            │
│ 当前生效: ENV (环境变量) ✅ 有效                    │
│                                                       │
│ [显示完整 Key] [刷新状态]                            │
└─────────────────────────────────────────────────────┘
```

**功能**：
- 实时显示环境检测结果
- 显示配置来源和优先级
- API Key 验证状态
- 快速操作按钮

#### 5.7.2 控制台日志

开发环境自动输出诊断信息：
- 启动时输出环境检测结果
- 显示配置来源和状态
- 验证过程的详细日志
- 错误信息和堆栈

#### 5.7.3 集成到诊断面板

扩展现有的 `DiagnosticPanel` 组件，添加 API Key 状态部分：
- 显示当前环境
- 显示配置来源
- 显示验证状态
- 提供测试按钮

### 5.8 错误处理和回退策略

#### 5.8.1 回退逻辑

**场景 1：用户自定义 Key 失效**
- 显示错误提示
- 提供三个选项：
  - 回退到环境配置（删除自定义设置）
  - 重新输入（修改自定义设置）
  - 保持使用（暂时忽略错误）

**场景 2：环境 Key 不存在或失效**
- 显示配置向导
- 根据当前环境提供对应的配置指引：
  - 本地环境：引导设置 `.env.local` 文件
  - Vercel 环境：引导在 Vercel Dashboard 设置环境变量

#### 5.8.2 错误分类

| 错误类型 | 表现 | 处理方式 | 用户提示 |
|---------|------|---------|---------|
| **配置缺失** | 没有任何 API Key | 显示首次使用引导 | "未检测到 API Key，请立即配置" |
| **Key 无效** | 格式错误或已禁用 | 提供重新输入/回退选项 | "API Key 验证失败，请检查" |
| **网络错误** | 无法连接验证服务 | 标记为"未测试"，允许继续使用 | "网络错误，无法验证但可继续使用" |
| **配额超限** | API 配额用尽 | 显示警告，提供 Console 链接 | "API 配额已用尽，请检查设置" |

### 5.9 测试检查清单

#### 5.9.1 核心功能测试
**环境检测**
- 本地开发环境检测
- Vercel 环境检测（production/preview/development）

**配置获取**
- 从环境变量获取 API Key
- 从 localStorage 获取用户自定义 Key
- 配置不存在时的处理

**选择逻辑**
- 用户自定义优先于环境变量
- 删除用户自定义后回退到环境变量
- 两者都不存在时的错误处理

**验证功能**
- API Key 格式验证
- API Key 有效性验证（调用 Google Maps API）
- 验证失败和网络错误的处理

#### 5.9.2 用户体验测试
**UI 交互**
- 添加/删除用户自定义 Key
- 显示/隐藏完整 Key（确认机制、自动隐藏）
- 复制 Key 到剪贴板

**安全性**
- Key 部分显示（前4后3字符）
- localStorage 存储的安全警告提示

**跨环境**
- 本地开发环境完整流程
- Vercel 预览和生产环境
- 环境切换时的状态保持

**错误场景**
- 首次使用无配置
- 用户自定义 Key 失效的回退
- 环境 Key 失效的提示
- 网络错误和配额超限

---

## 总结

### 设计核心

**环境隔离原则**
- Local ENV 和 Vercel ENV 是**互斥的运行环境**（不是优先级）
- 用户自定义配置可以在**任何环境**下覆盖环境默认值
- 简单的选择逻辑：`用户自定义 > 当前环境的环境变量`

### 架构要点

**四个关键模块**
1. **环境检测**：识别当前运行环境（本地/Vercel）
2. **配置管理器**：获取、设置、验证 API Key
3. **状态管理**：追踪当前生效配置和环境默认配置
4. **UI 展示**：清晰显示环境、来源和状态

**数据流**
```
环境变量 (ENV) ─┐
                 ├─→ 选择逻辑 ─→ 当前生效的配置 ─→ Google Maps
用户自定义 ────┘    (优先级)
```

### 用户价值

- ✅ **透明度**：清楚知道 API Key 从哪里来
- ✅ **灵活性**：快速切换测试不同 API Key
- ✅ **安全性**：环境变量优先，自定义为辅
- ✅ **易用性**：简单的添加/删除操作
- ✅ **可靠性**：完善的错误处理和回退机制

### 实现优先级

**Phase 1：核心功能**
- 环境检测和 API Key 选择逻辑
- 基础 UI（显示当前配置和来源）
- 添加/删除用户自定义配置

**Phase 2：增强体验**
- API Key 验证功能
- 错误处理和回退机制
- 首次使用引导

**Phase 3：完善细节**
- 安全显示（部分隐藏、自动隐藏）
- 调试工具和诊断面板
- 操作审计日志（可选）